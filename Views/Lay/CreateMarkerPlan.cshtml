@using Newtonsoft.Json
@{
    ViewData["Title"] = "Create Marker Plan";
    var styles = ViewBag.Styles as List<CutUsage.Models.StyleM>
                 ?? new List<CutUsage.Models.StyleM>();
}
@section Styles {
    <style>
        /* shrink all text */
        #buildPlanMatrixContainer table {
            font-size: .75rem;
        }

            /* header cells wrap, data cells don't */
            #buildPlanMatrixContainer table td {
                white-space: nowrap;
            }

            #buildPlanMatrixContainer table th {
                white-space: normal;
            }

                /* first two columns fixed at ~8ch */
                #buildPlanMatrixContainer table th:nth-of-type(1),
                #buildPlanMatrixContainer table td:nth-of-type(1),
                #buildPlanMatrixContainer table th:nth-of-type(2),
                #buildPlanMatrixContainer table td:nth-of-type(2) {
                    min-width: 8ch;
                    max-width: 8ch;
                }

                /* all other columns at ~5ch */
                #buildPlanMatrixContainer table th:nth-of-type(n+3),
                #buildPlanMatrixContainer table td:nth-of-type(n+3) {
                    min-width: 5ch;
                    max-width: 5ch;
                }
    </style>
}
<h2>@ViewData["Title"]</h2>

<form id="planForm" class="mb-4" method="post" asp-action="CreateMarkerPlan">
    <div class="row g-3 mb-3">
        <div class="col-12 col-md-4">
            <label for="styleInput" class="form-label">Select Style</label>

            <!-- free-text input that shows matching options from the datalist -->
            <input list="styleList"
                   id="styleInput"
                   name="Style"
                   class="form-control"
                   placeholder="Type or paste style…" />

            <datalist id="styleList">
                @foreach (var st in styles)
                {
                    <option value="@st.Style"></option>
                }
            </datalist>
        </div>

        <div class="col-12 col-md-4">
            <label for="soSelect" class="form-label">Select SO(s)</label>
            <select id="soSelect"
                    name="SelectedSO"
                    class="form-select"
                    multiple
                    disabled>
            </select>
        </div>

        <div class="col-12 col-md-4">
            <label for="docketSelect" class="form-label">Select Docket(s)</label>
            <select id="docketSelect"
                    name="SelectedDocket"
                    class="form-select"
                    multiple
                    disabled>
            </select>
        </div>
    </div>

    <div id="matrixContainer">
        @* Partial view will be injected here *@
    </div>

    <button type="submit" class="btn btn-primary">Save Plan</button>
</form>

@section Scripts {
    <script>
        const styleEl = document.getElementById('styleInput'),
            soEl = document.getElementById('soSelect'),
            dockEl = document.getElementById('docketSelect'),
            matrixCt = document.getElementById('matrixContainer');

        // fire when the user picks from the datalist or blurs the input
        styleEl.addEventListener('change', async () => {
            const style = styleEl.value;
            soEl.disabled = dockEl.disabled = true;
            soEl.innerHTML = '<option>Loading…</option>';
            dockEl.innerHTML = '';

            if (!style) {
                soEl.innerHTML = '<option>— choose a style —</option>';
                return;
            }
            const resp = await fetch(`/Lay/GetSOsByStyle?style=${encodeURIComponent(style)}`);
            const items = await resp.json();
            soEl.innerHTML = items.map(i => `<option value="${i.value}">${i.text}</option>`).join('');
            soEl.disabled = false;
        });

        soEl.addEventListener('change', async () => {
            const selectedSOs = [...soEl.selectedOptions].map(o => o.value);
            dockEl.disabled = true;
            dockEl.innerHTML = '<option>Loading…</option>';
            if (!selectedSOs.length) {
                dockEl.innerHTML = '';
                return;
            }
            const qs = selectedSOs.map(s => `so=${encodeURIComponent(s)}`).join('&');
            const resp = await fetch(`/Lay/GetDocketsBySO?${qs}`);
            const items = await resp.json();
            dockEl.innerHTML = items.map(i => `<option value="${i.value}">${i.text}</option>`).join('');
            dockEl.disabled = false;
        });

        dockEl.addEventListener('change', async () => {
            const selectedSOs = [...soEl.selectedOptions].map(o => o.value),
                selectedDocs = [...dockEl.selectedOptions].map(o => o.value);

            if (!selectedDocs.length) {
                matrixCt.innerHTML = '';
                return;
            }
            const qs = [
                ...selectedSOs.map(s => `so=${encodeURIComponent(s)}`),
                ...selectedDocs.map(d => `docket=${encodeURIComponent(d)}`)
            ].join('&');

            const resp = await fetch(`/Lay/BuildPlanMatrix?${qs}`);
            matrixCt.innerHTML = await resp.text();

            buildPlanMatrixInit();
            setupPropagation();
            setupCentralCalculation();
        });

        function buildPlanMatrixInit() {
            const vmScript = document.getElementById('matrix-data'),
                vm = vmScript
                    ? JSON.parse(vmScript.textContent)
                    : { Sizes: [], QtyMap: {}, ExistingCut: {} },
                sizes = vm.Sizes,
                orderMap = vm.QtyMap,
                existingMap = vm.ExistingCut;

            function recalc() {
                let totalCalc = 0,
                    totalRemain = 0;
                const ratios = {}, plies = {};

                document.querySelectorAll('.ratio-input').forEach(i => {
                    const d = i.dataset.docket,
                        s = i.dataset.size,
                        v = parseInt(i.value, 10) || 0;
                    if (!ratios[d]) ratios[d] = {};
                    ratios[d][s] = v;

                });

                document.querySelectorAll('.plies-input').forEach(i => {
                    plies[i.dataset.docket] = parseInt(i.value, 10) || 0;
                });

                sizes.forEach(s => {
                    const ord = orderMap[s] || 0,
                        cut = existingMap[s] || 0,
                        used = Object.entries(ratios).reduce((sum, [d, map]) =>
                            sum + (map[s] || 0) * (plies[d] || 0), 0),
                        remain = ord - cut - used;

                    document.getElementById(`calcQty_${s}`).textContent = used;
                    const remEl = document.getElementById(`remainQty_${s}`);
                    remEl.textContent = remain;
                    remEl.style.color = remain >= 0 ? 'green' : 'red';

                    totalCalc += used;
                    totalRemain += remain;
                });

                document.getElementById('calcQtyTotal').textContent = totalCalc;
                const remTotEl = document.getElementById('remainQtyTotal');
                remTotEl.textContent = totalRemain;
                remTotEl.style.color = totalRemain >= 0 ? 'green' : 'red';

                // ----- NEW: compute & display row-level size totals -----
                Object.keys(ratios).forEach(dock => {
                    const sum = Object.values(ratios[dock]).reduce((a, b) => a + b, 0);
                    const cell = document.querySelector(
                        `.row-total-size[data-docket="${dock}"]`
                    );
                    if (cell) cell.textContent = sum;
                });
            }

            document.querySelectorAll('.ratio-input, .plies-input')
                .forEach(i => i.addEventListener('input', recalc));
            recalc();
        }

        function setupPropagation() {
            // Total → plies → recalc
            document.querySelectorAll('.docket-total-input').forEach(input => {
                input.addEventListener('input', () => {
                    const d = input.dataset.docket;
                    const p = document.querySelector(`.plies-input[data-docket="${d}"]`);
                    if (p) {
                        p.value = input.value;
                        p.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                });
            });

            // marker-name → enable + copy length/width + dispatch
            document.querySelectorAll('.marker-name-input').forEach(input => {
                input.addEventListener('input', () => {
                    const name = input.value.trim(),
                        dock = input.dataset.docket,
                        lenEl = document.querySelector(`.marker-length-input[data-docket="${dock}"]`),
                        widEl = document.querySelector(`.marker-width-input[data-docket="${dock}"]`);

                    // enable/disable length & width
                    const enabled = name !== '';
                    lenEl.disabled = !enabled;
                    widEl.disabled = !enabled;

                    if (!enabled) {
                        lenEl.value = '';
                        widEl.value = '';
                        lenEl.dispatchEvent(new Event('input', { bubbles: true }));
                        widEl.dispatchEvent(new Event('input', { bubbles: true }));
                        return;
                    }

                    // copy from any other row with same name
                    document.querySelectorAll('.marker-name-input').forEach(other => {
                        if (other.dataset.docket !== dock && other.value.trim() === name) {
                            const od = other.dataset.docket,
                                srcLen = document.querySelector(`.marker-length-input[data-docket="${od}"]`).value,
                                srcWid = document.querySelector(`.marker-width-input[data-docket="${od}"]`).value;
                            if (srcLen || srcWid) {
                                lenEl.value = srcLen;
                                widEl.value = srcWid;
                                lenEl.dispatchEvent(new Event('input', { bubbles: true }));
                                widEl.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        }
                    });
                });
            });

            // length propagation + dispatch
            document.querySelectorAll('.marker-length-input').forEach(input => {
                input.addEventListener('input', e => {
                    // ← only run on true user input
                    if (!e.isTrusted) return;

                    const dock = input.dataset.docket,
                        val = input.value,
                        name = document.querySelector(
                            `.marker-name-input[data-docket="${dock}"]`
                        ).value.trim();
                    if (!name) return;

                    document.querySelectorAll('.marker-length-input').forEach(other => {
                        const od = other.dataset.docket,
                            on = document.querySelector(
                                `.marker-name-input[data-docket="${od}"]`
                            ).value.trim();
                        if (od !== dock && on === name) {
                            other.value = val;
                            // this synthetic event will have isTrusted === false
                            other.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    });
                });
            });

            // width propagation + dispatch
            document.querySelectorAll('.marker-width-input').forEach(input => {
                input.addEventListener('input', e => {
                    if (!e.isTrusted) return;

                    const dock = input.dataset.docket,
                        val = input.value,
                        name = document.querySelector(
                            `.marker-name-input[data-docket="${dock}"]`
                        ).value.trim();
                    if (!name) return;

                    document.querySelectorAll('.marker-width-input').forEach(other => {
                        const od = other.dataset.docket,
                            on = document.querySelector(
                                `.marker-name-input[data-docket="${od}"]`
                            ).value.trim();
                        if (od !== dock && on === name) {
                            other.value = val;
                            other.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    });
                });
            });
        }

        function setupCentralCalculation() {
            const vmScript = document.getElementById('matrix-data'),
                vm = vmScript ? JSON.parse(vmScript.textContent) : { Sizes: [], QtyMap: {}, ExistingCut: {} },
                sizes = vm.Sizes;

            function recalc() {
                let totalCalc = 0, totalRemain = 0;
                const ratios = {}, plies = {};

                document.querySelectorAll('.ratio-input').forEach(i => {
                    const d = i.dataset.docket,
                        s = i.dataset.size,
                        v = parseInt(i.value, 10) || 0;
                    if (!ratios[d]) ratios[d] = {};
                    ratios[d][s] = v;
                });

                document.querySelectorAll('.plies-input').forEach(i => {
                    plies[i.dataset.docket] = parseInt(i.value, 10) || 0;
                });

                sizes.forEach(s => {
                    const ord = vm.QtyMap[s] || 0,
                        cut = vm.ExistingCut[s] || 0,
                        used = Object.entries(ratios).reduce((sum, [d, map]) =>
                            sum + (map[s] || 0) * (plies[d] || 0), 0),
                        remain = ord - cut - used;

                    document.getElementById(`calcQty_${s}`).textContent = used;
                    const remEl = document.getElementById(`remainQty_${s}`);
                    remEl.textContent = remain;
                    remEl.style.color = remain >= 0 ? 'green' : 'red';

                    totalCalc += used;
                    totalRemain += remain;
                });

                document.getElementById('calcQtyTotal').textContent = totalCalc;
                const remTotEl = document.getElementById('remainQtyTotal');
                remTotEl.textContent = totalRemain;
                remTotEl.style.color = totalRemain >= 0 ? 'green' : 'red';
            }

            function calcFabric(dock) {
                const len = parseFloat(document.querySelector(`.marker-length-input[data-docket="${dock}"]`).value) || 0,
                    allow = parseFloat(document.querySelector(`.allowance-input[data-docket="${dock}"]`).value) || 0,
                    ply = parseInt(document.querySelector(`.plies-input[data-docket="${dock}"]`).value, 10) || 0,
                    fab = (len + allow) * ply,
                    cell = document.querySelector(`.fabric-req-cell[data-docket="${dock}"]`);
                if (cell) cell.textContent = fab.toFixed(3);
            }

            function calcUsage(dock) {
                // read Fabric Requirement
                const fab = parseFloat(
                    document.querySelector(`.fabric-req-cell[data-docket="${dock}"]`)
                        .textContent
                ) || 0;

                // read Total Size Count
                const total = parseFloat(
                    document.querySelector(`.row-total-size[data-docket="${dock}"]`)
                        .textContent
                ) || 0;

                // compute usage
                const usage = total > 0 ? fab / total : 0;

                // write into the marker-usage-cell
                const cell = document.querySelector(
                    `.marker-usage-cell[data-docket="${dock}"]`
                );
                if (cell) cell.textContent = usage.toFixed(3);
            }

            function calcSaving(dock) {
                const bom = parseFloat(
                    document.querySelector(
                        `.bom-usage-cell[data-docket="${dock}"]`
                    ).textContent
                ) || 0;

                const usage = parseFloat(
                    document.querySelector(
                        `.marker-usage-cell[data-docket="${dock}"]`
                    ).textContent
                ) || 0;

                const total = parseFloat(
                    document.querySelector(
                        `.row-total-size[data-docket="${dock}"]`
                    ).textContent
                ) || 0;

                const saving = (bom - usage) * total;

                const cell = document.querySelector(
                    `.marker-saving-cell[data-docket="${dock}"]`
                );
                if (cell) cell.textContent = saving.toFixed(3);
            }

            /**
        * Target Length = Total Size Count * BOM Usage
        */
            function calcTarget(dock) {
                const total = parseFloat(
                    document.querySelector(`.row-total-size[data-docket="${dock}"]`)
                        .textContent
                ) || 0;

                const bom = parseFloat(
                    document.querySelector(`.bom-usage-cell[data-docket="${dock}"]`)
                        .textContent
                ) || 0;

                const target = total * bom;

                const cell = document.querySelector(
                    `.target-length-cell[data-docket="${dock}"]`
                );
                if (cell) cell.textContent = target.toFixed(3);
            }

            function doAllCalculations() {
                recalc();
                document.querySelectorAll('.plies-input').forEach(i => {
                    const dock = i.dataset.docket;
                    calcFabric(dock);
                    calcUsage(dock);
                    calcSaving(dock);
                    calcTarget(dock);
                });

                let totalFab = 0, totalSave = 0;
                document.querySelectorAll('.fabric-req-cell')
                    .forEach(c => totalFab += parseFloat(c.textContent) || 0);
                document.querySelectorAll('.marker-saving-cell')
                    .forEach(c => totalSave += parseFloat(c.textContent) || 0);

                const fabCell = document.getElementById('fabricTotalCell'),
                    saveCell = document.getElementById('markerSavingTotalCell');
                if (fabCell) {
                    fabCell.textContent = totalFab.toFixed(3);
                    fabCell.style.color = 'blue';      // your first color
                }
                if (saveCell) {
                    saveCell.textContent = totalSave.toFixed(3);
                    saveCell.style.color = 'crimson';   // your second color
                }
            }

            document.querySelectorAll('.ratio-input, .plies-input, .allowance-input, .marker-length-input').forEach(i => {
                i.addEventListener('input', doAllCalculations);
            });

            doAllCalculations();
        }
    </script>
}


